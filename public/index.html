<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VideoLab</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0c10; --card:#15171c; --text:#e8eaf0; --muted:#9aa3b2; --accent:#2d6cdf; --danger:#e5484d; }
    * { box-sizing: border-box; }
    body { margin:0; font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:960px; margin:40px auto; padding:0 16px; }
    header { display:flex; align-items:center; gap:12px; margin-bottom:24px; }
    header h1 { margin:0; font-size:28px; letter-spacing:.3px; }
    .badge { font-size:12px; color:var(--muted); }
    .card { background:var(--card); border:1px solid #23252b; border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.35); }
    .row { display:flex; gap:10px; align-items:center; }
    .field { display:flex; flex-direction:column; gap:6px; flex:1; }
    label { color:var(--muted); font-size:13px; }
    input { width:100%; padding:10px 12px; border:1px solid #2a2e36; border-radius:10px; background:#0e1014; color:var(--text); outline:none; }
    input:focus { border-color:#3b4252; }
    button { padding:10px 16px; border:1px solid #2a2e36; background:var(--accent); color:white; border-radius:10px; cursor:pointer; }
    button.ghost { background:transparent; color:var(--text); }
    .tabs { display:flex; gap:10px; margin-bottom:12px; }
    .tab { padding:8px 12px; border:1px solid #2a2e36; border-radius:999px; color:var(--muted); cursor:pointer; }
    .tab.active { color:white; border-color:var(--accent); background:rgba(45,108,223,.15); }
    .stack { display:none; }
    .stack.active { display:block; }
    .msg { margin-top:12px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap; }
    .msg.error { color:var(--danger); }
    .msg.ok { color:#5ac8a2; }
    .small { font-size:13px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4 6h16a2 2 0 0 1 2 2v1H2V8a2 2 0 0 1 2-2Zm-2 7h20v3a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-3Zm5-9 2 3H5l2-3Zm4 0 2 3h-4l2-3Zm4 0 2 3h-4l2-3Z"/></svg>
      <h1>VideoLab</h1>
      <span class="badge" id="build">build: <span id="buildAt"></span></span>
    </header>

    <div class="card">
      <div class="tabs">
        <div class="tab active" data-tab="login">Login</div>
        <div class="tab" data-tab="signup">Sign up</div>
        <div class="tab" data-tab="confirm">Confirm email</div>
      </div>

      <!-- LOGIN -->
      <div class="stack active" id="panel-login">
        <div class="row" style="margin-bottom:10px">
          <div class="field">
            <label>Username</label>
            <input id="login-username" placeholder="alice"/>
          </div>
          <div class="field">
            <label>Password</label>
            <input id="login-password" type="password" placeholder="••••••••"/>
          </div>
          <div>
            <label style="visibility:hidden">Login</label>
            <button id="btn-login">Login</button>
          </div>
        </div>
        <div class="small">Tip: this uses <code>/cog/login</code> and expects a Cognito app client **without secret**.</div>
        <div class="msg" id="login-msg"></div>
      </div>

      <!-- SIGNUP -->
      <div class="stack" id="panel-signup">
        <div class="row" style="margin-bottom:10px">
          <div class="field">
            <label>Username</label>
            <input id="su-username" placeholder="alice"/>
          </div>
          <div class="field">
            <label>Email</label>
            <input id="su-email" type="email" placeholder="you@example.com"/>
          </div>
          <div class="field">
            <label>Password</label>
            <input id="su-password" type="password" placeholder="Abc12345!"/>
          </div>
          <div>
            <label style="visibility:hidden">Sign up</label>
            <button id="btn-signup">Sign up</button>
          </div>
        </div>
        <div class="small">After sign up, check your email for the 6-digit code, then use “Confirm email”.</div>
        <div class="msg" id="signup-msg"></div>
      </div>

      <!-- CONFIRM -->
      <div class="stack" id="panel-confirm">
        <div class="row" style="margin-bottom:10px">
          <div class="field">
            <label>Username</label>
            <input id="cf-username" placeholder="alice"/>
          </div>
          <div class="field">
            <label>Code</label>
            <input id="cf-code" placeholder="123456"/>
          </div>
          <div>
            <label style="visibility:hidden">Confirm</label>
            <button id="btn-confirm">Confirm</button>
          </div>
        </div>
        <div class="msg" id="confirm-msg"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div>
          <div class="small">Auth status:</div>
          <div id="auth-status" class="small">Not logged in</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="ghost" id="btn-copy">Copy ID token</button>
          <button class="ghost" id="btn-logout">Logout</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const AFTER_LOGIN = './app.js';
    // same-origin API base
    const API = "";
    // tabs
    document.querySelectorAll('.tab').forEach(t => {
      t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.stack').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        document.getElementById('panel-' + t.dataset.tab).classList.add('active');
      });
    });

    // helpers
    const $ = (id) => document.getElementById(id);
    const show = (id, text, ok=false) => {
      const el = $(id);
      el.className = 'msg ' + (ok ? 'ok' : 'error');
      el.textContent = text;
    }
    const setStatus = () => {
      const tok = localStorage.getItem('idToken');
      $('auth-status').textContent = tok ? 'Logged in (ID token stored)' : 'Not logged in';
    }
    const buildAt = new Date().toISOString();
    $('buildAt').textContent = buildAt;

    async function post(path, body) {
      const res = await fetch(API + path, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body || {})
      });
      const json = await res.json().catch(()=>({}));
      if (!res.ok || json.success === false) {
        const msg = json?.error?.message || res.statusText || 'Request failed';
        throw new Error(msg);
      }
      return json;
    }

    // SIGNUP
    $('btn-signup').addEventListener('click', async () => {
      const username = $('su-username').value.trim();
      const email    = $('su-email').value.trim();
      const password = $('su-password').value;
      try {
        const r = await post('/cog/signup', { username, email, password });
        show('signup-msg', 'Signup ok. Check email for code.', true);
      } catch (e) { show('signup-msg', 'Error: ' + e.message); }
    });

    // CONFIRM
    $('btn-confirm').addEventListener('click', async () => {
      const username = $('cf-username').value.trim();
      const code     = $('cf-code').value.trim();
      try {
        await post('/cog/confirm', { username, code });
        show('confirm-msg', 'Email confirmed. You can login now.', true);
      } catch (e) { show('confirm-msg', 'Error: ' + e.message); }
    });

    // LOGIN
    $('btn-login').addEventListener('click', async () => {
        const username = $('login-username').value.trim();
        const password = $('login-password').value;
        try {
            const r  = await post('/cog/login', { username, password });
            const id = r?.data?.idToken || r?.meta?.idToken || r?.idToken;
            if (!id) throw new Error('No idToken from server');

            localStorage.setItem('idToken', id);
            setStatus();
            show('login-msg', 'Login ok', true);

            // redirect
            window.location.replace(AFTER_LOGIN);
        } catch (e) {
            show('login-msg', 'Error: ' + e.message);
        }
    });


    // COPY / LOGOUT
    $('btn-copy').addEventListener('click', async () => {
      const id = localStorage.getItem('idToken') || '';
      if (!id) return alert('No token in storage.');
      try { await navigator.clipboard.writeText(id); alert('ID token copied'); }
      catch { alert('Copy failed'); }
    });
    $('btn-logout').addEventListener('click', () => {
      localStorage.removeItem('idToken');
      setStatus();
    });

    setStatus();
  </script>
</body>
</html>
